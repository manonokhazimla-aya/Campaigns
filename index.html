<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MTD Closing Ratio Dashboard - February 2025</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --light-bg: #ecf0f1;
            --dark-bg: #34495e;
            --admin-color: #e74c3c;
            --user-color: #27ae60;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f7fa;
            margin: 0;
            padding: 0;
        }

        .sidebar {
            background: linear-gradient(135deg, var(--primary-color), var(--dark-bg));
            min-height: 100vh;
            color: white;
            position: fixed;
            width: 280px;
            transition: all 0.3s;
            overflow-y: auto;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
        }

        .sidebar .nav-link {
            color: rgba(255, 255, 255, 0.8);
            padding: 1rem 1.5rem;
            font-size: 1rem;
            transition: all 0.3s;
            cursor: pointer;
            border-left: 3px solid transparent;
        }

        .sidebar .nav-link:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border-left-color: var(--secondary-color);
        }

        .sidebar .nav-link.active {
            background: rgba(52, 152, 219, 0.2);
            color: white;
            border-left-color: var(--secondary-color);
        }

        .sidebar .nav-link i {
            margin-right: 12px;
            width: 24px;
            text-align: center;
        }

        .sidebar .user-badge {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            margin: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .sidebar .user-badge .role-badge {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            margin-top: 10px;
        }

        .sidebar .user-badge .role-badge.admin {
            background: var(--admin-color);
            color: white;
        }

        .sidebar .user-badge .role-badge.user {
            background: var(--user-color);
            color: white;
        }

        .main-content {
            margin-left: 280px;
            padding: 20px;
        }

        .dashboard-header {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            position: relative;
        }

        .logout-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: transparent;
            border: 2px solid var(--danger-color);
            color: var(--danger-color);
            padding: 8px 20px;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .logout-btn:hover {
            background: var(--danger-color);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(231, 76, 60, 0.3);
        }

        .mobile-logout {
            display: none;
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1002;
            background: var(--danger-color);
            color: white;
            border: none;
            border-radius: 50px;
            padding: 12px 24px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(231, 76, 60, 0.4);
            font-weight: 600;
            align-items: center;
            gap: 8px;
        }

        .mobile-logout:hover {
            background: #c82333;
            transform: scale(1.05);
        }

        .role-indicator {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 15px;
        }

        .role-indicator.admin {
            background: var(--admin-color);
            color: white;
        }

        .role-indicator.user {
            background: var(--user-color);
            color: white;
        }

        .stat-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            transition: transform 0.3s, box-shadow 0.3s;
            margin-bottom: 25px;
            height: 100%;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .stat-icon {
            width: 70px;
            height: 70px;
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            margin-right: 20px;
        }

        .stat-icon.blue { background: linear-gradient(135deg, #3498db, #2980b9); color: white; }
        .stat-icon.green { background: linear-gradient(135deg, #27ae60, #229954); color: white; }
        .stat-icon.orange { background: linear-gradient(135deg, #f39c12, #e67e22); color: white; }
        .stat-icon.purple { background: linear-gradient(135deg, #9b59b6, #8e44ad); color: white; }
        .stat-icon.red { background: linear-gradient(135deg, #e74c3c, #c0392b); color: white; }

        .filter-section {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
        }

        .table-container {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            overflow-x: auto;
        }

        .table {
            margin-bottom: 0;
        }

        .table thead th {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 15px;
            font-weight: 500;
        }

        .table tbody tr:hover {
            background: var(--light-bg);
            cursor: pointer;
        }

        .badge-performance {
            padding: 6px 12px;
            border-radius: 20px;
            font-weight: 500;
        }

        .badge-high {
            background: linear-gradient(135deg, #27ae60, #229954);
            color: white;
        }

        .badge-medium {
            background: linear-gradient(135deg, #f39c12, #e67e22);
            color: white;
        }

        .badge-low {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
        }

        .upload-area {
            border: 3px dashed var(--secondary-color);
            border-radius: 15px;
            padding: 50px;
            text-align: center;
            background: #f8f9fa;
            cursor: pointer;
            transition: all 0.3s;
        }

        .upload-area:hover {
            background: #e9ecef;
            border-color: var(--primary-color);
        }

        .upload-area i {
            font-size: 64px;
            color: var(--secondary-color);
            margin-bottom: 20px;
        }

        .progress {
            height: 10px;
            margin-top: 15px;
            border-radius: 5px;
        }

        .campaign-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            margin: 2px;
            background: var(--secondary-color);
            color: white;
        }

        .ranking-card {
            background: white;
            border-radius: 12px;
            padding: 18px;
            margin-bottom: 15px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            transition: transform 0.2s;
        }

        .ranking-card:hover {
            transform: translateX(5px);
        }

        .ranking-card.high {
            border-left: 5px solid var(--success-color);
        }

        .ranking-card.low {
            border-left: 5px solid var(--danger-color);
        }

        .ranking-position {
            font-size: 20px;
            font-weight: bold;
            color: var(--primary-color);
            min-width: 45px;
        }

        .history-record {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            border-left: 5px solid var(--secondary-color);
        }

        .history-record.expanded {
            border-left-color: var(--success-color);
        }

        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }

        .history-details {
            display: none;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #dee2e6;
        }

        .history-details.show {
            display: block;
        }

        .history-stats {
            display: flex;
            gap: 20px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .history-stat-item {
            background: #f8f9fa;
            padding: 10px 15px;
            border-radius: 8px;
            text-align: center;
            flex: 1;
            min-width: 120px;
        }

        .history-stat-label {
            font-size: 12px;
            color: #6c757d;
        }

        .history-stat-value {
            font-size: 18px;
            font-weight: bold;
            color: var(--primary-color);
        }

        .admin-only {
            display: none;
        }

        .user-only {
            display: none;
        }

        body.admin .admin-only {
            display: block;
        }

        body.admin .user-only {
            display: none;
        }

        body.user .user-only {
            display: block;
        }

        body.user .admin-only {
            display: none;
        }

        .view-data-btn {
            background: var(--secondary-color);
            color: white;
            border: none;
            padding: 5px 15px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .view-data-btn:hover {
            background: var(--primary-color);
        }

        .restore-btn {
            background: var(--success-color);
            color: white;
            border: none;
            padding: 5px 15px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
            margin-left: 10px;
        }

        .restore-btn:hover {
            background: #218838;
        }

        .delete-btn {
            background: var(--danger-color);
            color: white;
            border: none;
            padding: 5px 15px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
            margin-left: 10px;
        }

        .delete-btn:hover {
            background: #c82333;
        }

        .data-preview {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            margin-top: 15px;
        }

        .data-preview table {
            font-size: 12px;
        }

        .data-preview table th {
            background: var(--light-bg);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        @media (max-width: 768px) {
            .sidebar {
                margin-left: -280px;
                position: fixed;
                z-index: 1000;
            }
            .sidebar.active {
                margin-left: 0;
            }
            .main-content {
                margin-left: 0;
            }
            .menu-toggle {
                display: block !important;
            }
            .logout-btn {
                display: none;
            }
            .mobile-logout {
                display: flex;
            }
        }

        .menu-toggle {
            display: none;
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1001;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 18px;
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.95);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            flex-direction: column;
        }

        .loading-overlay.active {
            display: flex;
        }

        .spinner {
            width: 60px;
            height: 60px;
            border: 5px solid var(--light-bg);
            border-top: 5px solid var(--secondary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
        }

        .toast {
            min-width: 300px;
            border-radius: 10px;
        }

        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        .login-container {
            max-width: 420px;
            margin: 120px auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.1);
            padding: 45px;
        }

        .btn-login {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 10px;
            padding: 14px;
            color: white;
            font-weight: 600;
            width: 100%;
            transition: all 0.3s;
        }

        .btn-login:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        .file-format-info {
            background: #e8f4fd;
            border-left: 5px solid var(--secondary-color);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 25px;
        }

        .summary-stats {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 25px;
        }

        .summary-stats .stat-value {
            font-size: 32px;
            font-weight: bold;
        }

        .summary-stats .stat-label {
            font-size: 14px;
            opacity: 0.9;
        }

        .campaign-tab {
            padding: 10px 20px;
            margin: 0 5px 10px 0;
            border: none;
            border-radius: 25px;
            background: #f8f9fa;
            color: var(--primary-color);
            cursor: pointer;
            transition: all 0.3s;
        }

        .campaign-tab:hover {
            background: var(--secondary-color);
            color: white;
        }

        .campaign-tab.active {
            background: var(--primary-color);
            color: white;
        }

        .clear-data-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .clear-data-btn:hover {
            background: #c82333;
            transform: translateY(-2px);
        }

        .role-selector {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            justify-content: center;
        }

        .role-btn {
            padding: 15px 30px;
            border: 2px solid #dee2e6;
            border-radius: 10px;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            flex: 1;
        }

        .role-btn:hover {
            border-color: var(--secondary-color);
            transform: translateY(-2px);
        }

        .role-btn.selected {
            border-color: var(--secondary-color);
            background: #e8f4fd;
        }

        .role-btn.admin.selected {
            border-color: var(--admin-color);
            background: #fde8e8;
        }

        .role-btn.user.selected {
            border-color: var(--user-color);
            background: #e8f8e8;
        }

        .role-btn i {
            font-size: 24px;
            margin-bottom: 10px;
        }

        .role-btn.admin i {
            color: var(--admin-color);
        }

        .role-btn.user i {
            color: var(--user-color);
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
        <h5 id="loadingMessage">Processing data...</h5>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Menu Toggle for Mobile -->
    <button class="menu-toggle" onclick="toggleSidebar()">
        <i class="fas fa-bars"></i>
    </button>

    <!-- Mobile Logout Button -->
    <button class="mobile-logout" onclick="confirmLogout()">
        <i class="fas fa-sign-out-alt"></i> Logout
    </button>

    <!-- Login Section -->
    <div id="loginSection" class="section active">
        <div class="login-container">
            <div class="text-center mb-4">
                <i class="fas fa-chart-line fa-4x" style="color: #667eea;"></i>
                <h3 class="mt-4">MTD Closing Ratio Dashboard</h3>
                <p class="text-muted">February 2025</p>
            </div>
            
            <div class="role-selector">
                <div class="role-btn admin" onclick="selectRole('admin')" id="adminRoleBtn">
                    <i class="fas fa-user-cog"></i>
                    <h6>Admin</h6>
                    <small>Can upload and manage data</small>
                </div>
                <div class="role-btn user" onclick="selectRole('user')" id="userRoleBtn">
                    <i class="fas fa-user"></i>
                    <h6>User</h6>
                    <small>View only access</small>
                </div>
            </div>
            
            <form onsubmit="handleLogin(event)">
                <div class="mb-3">
                    <label class="form-label">Username</label>
                    <input type="text" id="username" class="form-control" placeholder="Enter username" value="admin" required>
                </div>
                
                <div class="mb-4">
                    <label class="form-label">Password</label>
                    <input type="password" id="password" class="form-control" placeholder="Enter password" value="admin123" required>
                </div>
                
                <button type="submit" class="btn-login">
                    <i class="fas fa-sign-in-alt me-2"></i>Sign In
                </button>
                
                <div class="alert alert-info mt-4">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>Demo Credentials:</strong><br>
                    Admin: admin / admin123<br>
                    User: user / user123
                </div>
            </form>
        </div>
    </div>

    <!-- Main App (Hidden until login) -->
    <div id="mainApp" style="display: none;">
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="user-badge">
                <i class="fas fa-user-circle fa-3x mb-2"></i>
                <h6 id="sidebarUsername">Admin User</h6>
                <span id="sidebarRole" class="role-badge admin">Administrator</span>
                <div class="mt-3">
                    <button class="btn btn-sm btn-outline-light w-100" onclick="confirmLogout()">
                        <i class="fas fa-sign-out-alt me-2"></i>Logout
                    </button>
                </div>
            </div>
            <nav class="nav flex-column">
                <a class="nav-link active" onclick="showSection('dashboard')">
                    <i class="fas fa-tachometer-alt"></i> Dashboard
                </a>
                <a class="nav-link admin-only" onclick="showSection('upload')">
                    <i class="fas fa-upload"></i> Upload Excel
                </a>
                <a class="nav-link" onclick="showSection('campaigns')">
                    <i class="fas fa-bullhorn"></i> Campaigns
                </a>
                <a class="nav-link" onclick="showSection('agents')">
                    <i class="fas fa-users"></i> Agents
                </a>
                <a class="nav-link" onclick="showSection('leaders')">
                    <i class="fas fa-user-tie"></i> Team Leaders
                </a>
                <a class="nav-link" onclick="showSection('rankings')">
                    <i class="fas fa-trophy"></i> Rankings
                </a>
                <a class="nav-link admin-only" onclick="showSection('history')">
                    <i class="fas fa-history"></i> Upload History
                </a>
            </nav>
        </div>

        <!-- Main Content -->
        <div class="main-content" id="mainContent">
            <div class="dashboard-header">
                <button class="logout-btn" onclick="confirmLogout()">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
                <div class="row align-items-center">
                    <div class="col-md-6">
                        <h3 id="pageTitle">Dashboard</h3>
                        <p class="text-muted mb-0">
                            <i class="fas fa-calendar-alt me-2"></i>February 2025
                            <span class="mx-2">|</span>
                            <i class="fas fa-user me-2"></i>Welcome back, <span id="usernameDisplay">Admin</span>
                            <span id="roleDisplay" class="role-indicator admin">Administrator</span>
                        </p>
                    </div>
                    <div class="col-md-6 text-end">
                        <button class="btn btn-primary me-2" onclick="refreshData()">
                            <i class="fas fa-sync-alt me-2"></i>Refresh
                        </button>
                        <button class="btn btn-success me-2" onclick="exportData()">
                            <i class="fas fa-download me-2"></i>Export
                        </button>
                        <button class="clear-data-btn admin-only" onclick="clearAllData()">
                            <i class="fas fa-trash me-2"></i>Clear Data
                        </button>
                    </div>
                </div>
            </div>

            <!-- Dashboard Section -->
            <div id="dashboardSection" class="section active">
                <!-- Filter Section -->
                <div class="filter-section">
                    <h5 class="mb-4"><i class="fas fa-filter me-2"></i>Filters</h5>
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label class="form-label fw-bold">Campaign</label>
                            <select class="form-select" id="campaignFilter" onchange="applyFilters()">
                                <option value="all">All Campaigns</option>
                            </select>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label fw-bold">Team Leader</label>
                            <select class="form-select" id="teamLeaderFilter" onchange="applyFilters()">
                                <option value="all">All Team Leaders</option>
                            </select>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label fw-bold">Agent</label>
                            <select class="form-select" id="agentFilter" onchange="applyFilters()">
                                <option value="all">All Agents</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Summary Stats -->
                <div class="summary-stats">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="stat-label">Total Campaigns</div>
                            <div class="stat-value" id="totalCampaigns">0</div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-label">Total Agents</div>
                            <div class="stat-value" id="totalAgents">0</div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-label">Total Calls</div>
                            <div class="stat-value" id="totalCalls">0</div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-label">Total Sales</div>
                            <div class="stat-value" id="totalSales">0</div>
                        </div>
                    </div>
                </div>

                <!-- Statistics Cards -->
                <div class="row mb-4" id="statCards">
                    <!-- Dynamically populated -->
                </div>

                <!-- Campaign Quick Stats -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="table-container">
                            <h5 class="mb-4"><i class="fas fa-bullseye me-2"></i>Campaign Performance Overview</h5>
                            <div class="d-flex flex-wrap mb-4" id="campaignQuickStats">
                                <!-- Dynamically populated -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Rankings Section -->
                <div class="row">
                    <div class="col-md-6 mb-4">
                        <div class="table-container">
                            <h5 class="mb-4">
                                <i class="fas fa-arrow-up text-success me-2"></i>
                                Top 10 Performers
                            </h5>
                            <div id="topPerformers">
                                <!-- Dynamically populated -->
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 mb-4">
                        <div class="table-container">
                            <h5 class="mb-4">
                                <i class="fas fa-arrow-down text-danger me-2"></i>
                                Bottom 10 Performers
                            </h5>
                            <div id="bottomPerformers">
                                <!-- Dynamically populated -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Data Tables -->
                <ul class="nav nav-tabs mb-4" id="dataTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" onclick="showTab('campaigns')">
                            <i class="fas fa-bullhorn me-2"></i>By Campaign
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" onclick="showTab('teamleaders')">
                            <i class="fas fa-user-tie me-2"></i>By Team Leader
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" onclick="showTab('agents')">
                            <i class="fas fa-users me-2"></i>By Agent
                        </button>
                    </li>
                </ul>
                <div class="tab-content">
                    <div class="tab-pane active" id="campaignsTab">
                        <div class="table-container">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Campaign</th>
                                        <th>Agents</th>
                                        <th>Total Calls</th>
                                        <th>Total Sales</th>
                                        <th>Closing Ratio</th>
                                        <th>Performance</th>
                                    </tr>
                                </thead>
                                <tbody id="campaignsTable">
                                    <!-- Dynamically populated -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="tab-pane" id="teamleadersTab" style="display: none;">
                        <div class="table-container">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Team Leader</th>
                                        <th>Agents</th>
                                        <th>Campaigns</th>
                                        <th>Total Calls</th>
                                        <th>Total Sales</th>
                                        <th>Closing Ratio</th>
                                    </tr>
                                </thead>
                                <tbody id="teamLeadersTable">
                                    <!-- Dynamically populated -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="tab-pane" id="agentsTab" style="display: none;">
                        <div class="table-container">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Agent Name</th>
                                        <th>User ID</th>
                                        <th>Team Leader</th>
                                        <th>Campaigns</th>
                                        <th>Total Calls</th>
                                        <th>Total Sales</th>
                                        <th>Closing Ratio</th>
                                    </tr>
                                </thead>
                                <tbody id="agentsTable">
                                    <!-- Dynamically populated -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Upload Section (Admin Only) -->
            <div id="uploadSection" class="section admin-only">
                <div class="table-container">
                    <h5 class="mb-4"><i class="fas fa-upload me-2"></i>Upload Excel File</h5>
                    
                    <div class="file-format-info">
                        <i class="fas fa-info-circle fa-2x me-3 float-start"></i>
                        <div>
                            <strong>Expected Format:</strong> Excel file (.xlsx) with multiple sheets<br>
                            Each sheet should have columns: USER NAME, ID, CURRENT USER GROUP, CALLS, SALE<br>
                            Sheet names represent campaign names (ABSA, CARTRACK, A&G, BUDGET, DAIL DIRECT, FIRTS FOR WOMEN, DISCOVERY, IWYZE, NEW MIWAY, DEALER, KP2, OLD MIWAY)
                        </div>
                    </div>
                    
                    <div class="upload-area" onclick="document.getElementById('fileInput').click()">
                        <i class="fas fa-cloud-upload-alt"></i>
                        <h5>Click to upload or drag and drop</h5>
                        <p class="text-muted">Supported format: .xlsx (Excel)</p>
                        <p class="text-muted small">Maximum file size: 10MB</p>
                    </div>
                    <input type="file" id="fileInput" accept=".xlsx" style="display: none;" onchange="handleFileUpload(this)">
                    
                    <!-- Upload Progress -->
                    <div id="uploadProgress" style="display: none;">
                        <div class="progress mt-4">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                 role="progressbar" style="width: 0%" id="progressBar"></div>
                        </div>
                        <p class="text-center mt-3" id="progressText">Processing sheets...</p>
                    </div>

                    <!-- Validation Results -->
                    <div id="validationResults" class="mt-4" style="display: none;">
                        <h6 class="mb-3">Upload Results</h6>
                        <div class="alert" id="resultAlert"></div>
                        <div id="errorList"></div>
                    </div>
                </div>
            </div>

            <!-- Campaigns Section -->
            <div id="campaignsSection" class="section">
                <div class="table-container">
                    <h5 class="mb-4"><i class="fas fa-bullhorn me-2"></i>All Campaigns Performance</h5>
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Campaign</th>
                                <th>Agents</th>
                                <th>Total Calls</th>
                                <th>Total Sales</th>
                                <th>Closing Ratio</th>
                                <th>Top Agent</th>
                                <th>Top Ratio</th>
                            </tr>
                        </thead>
                        <tbody id="allCampaignsTable">
                            <!-- Dynamically populated -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Agents Section -->
            <div id="agentsSection" class="section">
                <div class="table-container">
                    <h5 class="mb-4"><i class="fas fa-users me-2"></i>All Agents Performance</h5>
                    <table class="table table-hover" id="agentsFullTable">
                        <thead>
                            <tr>
                                <th>Agent Name</th>
                                <th>User ID</th>
                                <th>Team Leader</th>
                                <th>Campaigns</th>
                                <th>Total Calls</th>
                                <th>Total Sales</th>
                                <th>Closing Ratio</th>
                                <th>Rank</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Dynamically populated -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Team Leaders Section -->
            <div id="leadersSection" class="section">
                <div class="table-container">
                    <h5 class="mb-4"><i class="fas fa-user-tie me-2"></i>Team Leaders Performance</h5>
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Team Leader</th>
                                <th>Agents</th>
                                <th>Campaigns</th>
                                <th>Total Calls</th>
                                <th>Total Sales</th>
                                <th>Closing Ratio</th>
                                <th>Team Average</th>
                            </tr>
                        </thead>
                        <tbody id="allTeamLeadersTable">
                            <!-- Dynamically populated -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Rankings Section -->
            <div id="rankingsSection" class="section">
                <div class="row">
                    <div class="col-md-6 mb-4">
                        <div class="table-container">
                            <h5 class="mb-4">
                                <i class="fas fa-trophy text-warning me-2"></i>
                                Highest Closing Ratios
                            </h5>
                            <div id="highestRankings"></div>
                        </div>
                    </div>
                    <div class="col-md-6 mb-4">
                        <div class="table-container">
                            <h5 class="mb-4">
                                <i class="fas fa-chart-line text-danger me-2"></i>
                                Lowest Closing Ratios
                            </h5>
                            <div id="lowestRankings"></div>
                        </div>
                    </div>
                </div>
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="table-container">
                            <h5 class="mb-4"><i class="fas fa-star me-2"></i>Performance Distribution</h5>
                            <div class="row text-center">
                                <div class="col-md-3">
                                    <div class="badge-performance badge-high mb-2">Excellent (â‰¥10%)</div>
                                    <h3 id="excellentCount">0</h3>
                                </div>
                                <div class="col-md-3">
                                    <div class="badge-performance badge-medium mb-2">Good (5-9.9%)</div>
                                    <h3 id="goodCount">0</h3>
                                </div>
                                <div class="col-md-3">
                                    <div class="badge-performance badge-low mb-2">Needs Improvement (2-4.9%)</div>
                                    <h3 id="improvementCount">0</h3>
                                </div>
                                <div class="col-md-3">
                                    <div class="badge-performance bg-secondary text-white mb-2">Critical (0-1.9%)</div>
                                    <h3 id="criticalCount">0</h3>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- History Section (Admin Only) -->
            <div id="historySection" class="section admin-only">
                <div class="table-container">
                    <h5 class="mb-4">
                        <i class="fas fa-history me-2"></i>Upload History
                        <button class="btn btn-sm btn-outline-primary float-end" onclick="refreshHistory()">
                            <i class="fas fa-sync-alt me-1"></i>Refresh
                        </button>
                    </h5>
                    
                    <div id="historyList">
                        <!-- Dynamically populated -->
                    </div>
                    
                    <div id="noHistoryMessage" class="text-center p-5 text-muted" style="display: none;">
                        <i class="fas fa-cloud-upload-alt fa-3x mb-3"></i>
                        <h5>No upload history</h5>
                        <p>Upload an Excel file to see the history here</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Data Preview Modal -->
    <div class="modal fade" id="dataPreviewModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="previewModalTitle">Uploaded Data Preview</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <div class="row">
                            <div class="col-md-3">
                                <strong>Filename:</strong> <span id="previewFilename"></span>
                            </div>
                            <div class="col-md-3">
                                <strong>Date:</strong> <span id="previewDate"></span>
                            </div>
                            <div class="col-md-3">
                                <strong>Records:</strong> <span id="previewRecords"></span>
                            </div>
                            <div class="col-md-3">
                                <strong>Campaigns:</strong> <span id="previewCampaigns"></span>
                            </div>
                        </div>
                    </div>
                    <div class="data-preview" id="dataPreviewContainer">
                        <!-- Data table will be inserted here -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-success admin-only" onclick="exportHistoryData()">
                        <i class="fas fa-download me-1"></i>Export This Version
                    </button>
                    <button type="button" class="btn btn-primary admin-only" onclick="restoreHistoryData()">
                        <i class="fas fa-undo me-1"></i>Restore This Version
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Logout Confirmation Modal -->
    <div class="modal fade" id="logoutConfirmModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Confirm Logout</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to logout?</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" onclick="logout()">Logout</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        // Global variables
        let currentUser = null;
        let selectedRole = 'admin'; // Default role selection
        let performanceData = {
            campaigns: {},
            teamLeaders: {},
            agents: {},
            records: []
        };
        let uploadHistory = [];
        let currentFilters = {
            campaign: 'all',
            team_leader: 'all',
            agent: 'all'
        };
        let currentPreviewId = null;
        let modalInstance = null;
        let logoutModalInstance = null;

        // Campaign list from your file
        const CAMPAIGNS = [
            'ABSA', 'CARTRACK', 'A&G', 'BUDGET', 'DAIL DIRECT', 
            'FIRTS FOR WOMEN', 'DISCOVERY', 'IWYZE', 'NEW MIWAY', 
            'DEALER', 'KP2', 'OLD MIWAY'
        ];

        // User credentials
        const USERS = {
            admin: { password: 'admin123', role: 'admin', name: 'Admin User' },
            user: { password: 'user123', role: 'user', name: 'Regular User' }
        };

        // Initialize the app
        document.addEventListener('DOMContentLoaded', function() {
            loadFromStorage();
            // Initialize modals
            modalInstance = new bootstrap.Modal(document.getElementById('dataPreviewModal'));
            logoutModalInstance = new bootstrap.Modal(document.getElementById('logoutConfirmModal'));
            // Default select admin role
            selectRole('admin');
        });

        function selectRole(role) {
            selectedRole = role;
            document.getElementById('adminRoleBtn').classList.remove('selected');
            document.getElementById('userRoleBtn').classList.remove('selected');
            document.getElementById(role + 'RoleBtn').classList.add('selected');
            
            // Set default username based on role
            document.getElementById('username').value = role;
        }

        function loadFromStorage() {
            const saved = localStorage.getItem('mtdClosingRatio');
            if (saved) {
                try {
                    const data = JSON.parse(saved);
                    performanceData = data.performanceData || performanceData;
                    uploadHistory = data.uploadHistory || [];
                } catch (e) {
                    console.error('Error loading data', e);
                }
            }
        }

        function saveToStorage() {
            localStorage.setItem('mtdClosingRatio', JSON.stringify({
                performanceData: performanceData,
                uploadHistory: uploadHistory
            }));
        }

        function clearAllData() {
            if (confirm('Are you sure you want to clear all data? This cannot be undone.')) {
                performanceData = {
                    campaigns: {},
                    teamLeaders: {},
                    agents: {},
                    records: []
                };
                uploadHistory = [];
                saveToStorage();
                refreshData();
                refreshHistory();
                showToast('All data cleared successfully', 'info');
            }
        }

        // Authentication functions
        function handleLogin(event) {
            event.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            // Check credentials
            const user = USERS[username];
            if (user && user.password === password) {
                // Verify role matches selection
                if (user.role !== selectedRole) {
                    showToast(`Please select the correct role (${user.role})`, 'warning');
                    return;
                }
                
                currentUser = { 
                    username: username, 
                    role: user.role,
                    name: user.name
                };
                
                // Set body class for role-based visibility
                document.body.className = user.role;
                
                // Update UI
                document.getElementById('loginSection').style.display = 'none';
                document.getElementById('mainApp').style.display = 'block';
                document.getElementById('usernameDisplay').textContent = user.name;
                document.getElementById('sidebarUsername').textContent = user.name;
                
                const roleBadge = document.getElementById('sidebarRole');
                roleBadge.className = `role-badge ${user.role}`;
                roleBadge.textContent = user.role === 'admin' ? 'Administrator' : 'Viewer';
                
                const roleDisplay = document.getElementById('roleDisplay');
                roleDisplay.className = `role-indicator ${user.role}`;
                roleDisplay.textContent = user.role === 'admin' ? 'Administrator' : 'Viewer';
                
                showSection('dashboard');
                refreshData();
                showToast(`Welcome ${user.name}! You are logged in as ${user.role}`, 'success');
            } else {
                showToast('Invalid credentials', 'danger');
            }
        }

        function confirmLogout() {
            logoutModalInstance.show();
        }

        function logout() {
            // Hide logout modal
            logoutModalInstance.hide();
            
            // Clear current user
            currentUser = null;
            
            // Reset body class
            document.body.className = '';
            
            // Hide main app and show login
            document.getElementById('mainApp').style.display = 'none';
            document.getElementById('loginSection').style.display = 'block';
            
            // Reset form
            document.getElementById('username').value = selectedRole;
            document.getElementById('password').value = selectedRole === 'admin' ? 'admin123' : 'user123';
            
            // Show success message
            showToast('Logged out successfully', 'info');
            
            // Reset any open sections
            showSection('dashboard');
        }

        // UI functions
        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('active');
        }

        function showSection(sectionId) {
            // Check if user has permission to view this section
            if (sectionId === 'upload' || sectionId === 'history') {
                if (!currentUser || currentUser.role !== 'admin') {
                    showToast('You do not have permission to access this section', 'warning');
                    return;
                }
            }
            
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            event.target.closest('.nav-link').classList.add('active');
            
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(sectionId + 'Section').classList.add('active');
            
            const titles = {
                'dashboard': 'Dashboard',
                'upload': 'Upload Excel',
                'campaigns': 'Campaigns',
                'agents': 'Agents',
                'leaders': 'Team Leaders',
                'rankings': 'Rankings',
                'history': 'Upload History'
            };
            document.getElementById('pageTitle').textContent = titles[sectionId];
            
            if (sectionId === 'campaigns') loadCampaignsData();
            if (sectionId === 'agents') loadAgentsData();
            if (sectionId === 'leaders') loadTeamLeadersData();
            if (sectionId === 'rankings') loadRankingsData();
            if (sectionId === 'history') refreshHistory();
            
            if (window.innerWidth <= 768) {
                document.getElementById('sidebar').classList.remove('active');
            }
        }

        function showTab(tabName) {
            document.querySelectorAll('.nav-tabs .nav-link').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            document.querySelectorAll('.tab-pane').forEach(tab => {
                tab.style.display = 'none';
            });
            document.getElementById(tabName + 'Tab').style.display = 'block';
        }

        function showLoading(message = 'Processing data...') {
            document.getElementById('loadingMessage').textContent = message;
            document.getElementById('loadingOverlay').classList.add('active');
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.remove('active');
        }

        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast align-items-center text-white bg-${type} border-0 mb-2`;
            toast.setAttribute('role', 'alert');
            toast.innerHTML = `
                <div class="d-flex">
                    <div class="toast-body">
                        <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'danger' ? 'fa-exclamation-circle' : 'fa-info-circle'} me-2"></i>
                        ${message}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>
            `;
            
            document.getElementById('toastContainer').appendChild(toast);
            const bsToast = new bootstrap.Toast(toast);
            bsToast.show();
            
            setTimeout(() => {
                toast.remove();
            }, 5000);
        }

        // File upload handling (Admin only)
        function handleFileUpload(input) {
            if (!currentUser || currentUser.role !== 'admin') {
                showToast('Only admins can upload files', 'danger');
                return;
            }
            
            const file = input.files[0];
            if (!file) return;
            
            showLoading('Reading Excel file...');
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    showLoading(`Processing ${workbook.SheetNames.length} campaigns...`);
                    
                    // Process each sheet (campaign)
                    const allRecords = [];
                    const processedSheets = [];
                    const errors = [];
                    const campaignData = {};
                    
                    workbook.SheetNames.forEach((sheetName, sheetIndex) => {
                        // Skip empty sheets
                        if (sheetName === 'Sheet12' || !sheetName.trim()) return;
                        
                        const worksheet = workbook.Sheets[sheetName];
                        const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                        
                        // Find the header row
                        let headerRow = -1;
                        for (let i = 0; i < Math.min(10, jsonData.length); i++) {
                            const row = jsonData[i];
                            if (row && row[0] === 'USER NAME') {
                                headerRow = i;
                                break;
                            }
                        }
                        
                        if (headerRow === -1) {
                            errors.push(`Sheet "${sheetName}": Could not find header row`);
                            return;
                        }
                        
                        campaignData[sheetName] = [];
                        
                        // Process data rows
                        for (let i = headerRow + 1; i < jsonData.length; i++) {
                            const row = jsonData[i];
                            if (!row || row.length < 5) continue;
                            
                            const userName = row[0];
                            const userId = row[1];
                            const teamLeader = row[2];
                            const calls = row[3];
                            const sales = row[4];
                            
                            // Skip empty rows and totals row
                            if (!userName || userName === 'TOTAL' || userName === 'AVERAGE' || userName.toString().includes('SUM')) continue;
                            
                            // Validate data
                            if (userName && userId && teamLeader) {
                                const callsNum = parseFloat(calls) || 0;
                                const salesNum = parseFloat(sales) || 0;
                                
                                if (callsNum > 0) {
                                    const record = {
                                        'USER NAME': userName.toString().trim(),
                                        'ID': userId.toString().trim(),
                                        'TEAM LEADER': teamLeader.toString().trim(),
                                        'CALLS': callsNum,
                                        'SALE': salesNum,
                                        'CAMPAIGN': sheetName,
                                        'closingRatio': ((salesNum / callsNum) * 100).toFixed(2)
                                    };
                                    allRecords.push(record);
                                    campaignData[sheetName].push(record);
                                }
                            }
                        }
                        
                        processedSheets.push(sheetName);
                    });
                    
                    if (allRecords.length > 0) {
                        processUploadedData(allRecords, campaignData, file.name, processedSheets, errors);
                    } else {
                        hideLoading();
                        showToast('No valid records found in the file', 'warning');
                    }
                    
                } catch (error) {
                    hideLoading();
                    showToast('Error reading file: ' + error.message, 'danger');
                    console.error(error);
                }
            };
            
            reader.readAsArrayBuffer(file);
        }

        function processUploadedData(records, campaignData, filename, processedSheets, errors) {
            showLoading(`Processing ${records.length} records...`);
            
            // Clear existing data and add new records
            performanceData = {
                campaigns: {},
                teamLeaders: {},
                agents: {},
                records: []
            };
            
            // Add all records
            records.forEach(record => {
                performanceData.records.push({
                    ...record,
                    id: Date.now() + Math.random(),
                    uploadDate: new Date().toISOString()
                });
                
                // Update campaign data
                const campaign = record['CAMPAIGN'];
                if (!performanceData.campaigns[campaign]) {
                    performanceData.campaigns[campaign] = {
                        totalCalls: 0,
                        totalSales: 0,
                        agents: new Set(),
                        records: []
                    };
                }
                performanceData.campaigns[campaign].totalCalls += record['CALLS'];
                performanceData.campaigns[campaign].totalSales += record['SALE'];
                performanceData.campaigns[campaign].agents.add(record['USER NAME']);
                performanceData.campaigns[campaign].records.push(record);
                
                // Update team leader data
                const leader = record['TEAM LEADER'];
                if (!performanceData.teamLeaders[leader]) {
                    performanceData.teamLeaders[leader] = {
                        totalCalls: 0,
                        totalSales: 0,
                        agents: new Set(),
                        campaigns: new Set()
                    };
                }
                performanceData.teamLeaders[leader].totalCalls += record['CALLS'];
                performanceData.teamLeaders[leader].totalSales += record['SALE'];
                performanceData.teamLeaders[leader].agents.add(record['USER NAME']);
                performanceData.teamLeaders[leader].campaigns.add(campaign);
                
                // Update agent data
                const agentKey = `${record['USER NAME']} (${record['ID']})`;
                if (!performanceData.agents[agentKey]) {
                    performanceData.agents[agentKey] = {
                        name: record['USER NAME'],
                        userId: record['ID'],
                        teamLeader: record['TEAM LEADER'],
                        campaigns: new Set(),
                        totalCalls: 0,
                        totalSales: 0
                    };
                }
                performanceData.agents[agentKey].totalCalls += record['CALLS'];
                performanceData.agents[agentKey].totalSales += record['SALE'];
                performanceData.agents[agentKey].campaigns.add(campaign);
            });
            
            // Calculate summary statistics for history
            const summary = {
                totalCalls: records.reduce((sum, r) => sum + r['CALLS'], 0),
                totalSales: records.reduce((sum, r) => sum + r['SALE'], 0),
                uniqueAgents: new Set(records.map(r => r['USER NAME'])).size,
                uniqueTeamLeaders: new Set(records.map(r => r['TEAM LEADER'])).size,
                avgRatio: (records.reduce((sum, r) => sum + r['CALLS'], 0) > 0 ? 
                    (records.reduce((sum, r) => sum + r['SALE'], 0) / records.reduce((sum, r) => sum + r['CALLS'], 0) * 100).toFixed(2) : 0)
            };
            
            // Add to upload history with full data
            uploadHistory.unshift({
                id: Date.now(),
                date: new Date().toLocaleString(),
                timestamp: new Date().toISOString(),
                filename: filename,
                campaigns: processedSheets.length,
                campaignList: processedSheets,
                records: records.length,
                valid: records.length,
                invalid: errors.length,
                errors: errors,
                status: errors.length === 0 ? 'Success' : 'Partial Success',
                data: records,
                campaignData: campaignData,
                summary: summary,
                uploadedBy: currentUser ? currentUser.name : 'Admin'
            });
            
            // Keep only last 20 uploads to prevent storage issues
            if (uploadHistory.length > 20) {
                uploadHistory = uploadHistory.slice(0, 20);
            }
            
            saveToStorage();
            hideLoading();
            
            // Show results
            showUploadResults(records.length, processedSheets, errors);
            
            // Refresh dashboard and history
            refreshData();
            if (currentUser && currentUser.role === 'admin') {
                refreshHistory();
            }
        }

        function showUploadResults(recordCount, sheets, errors) {
            const validationDiv = document.getElementById('validationResults');
            const resultAlert = document.getElementById('resultAlert');
            const errorList = document.getElementById('errorList');
            
            validationDiv.style.display = 'block';
            
            if (errors.length === 0) {
                resultAlert.className = 'alert alert-success';
                resultAlert.innerHTML = `
                    <i class="fas fa-check-circle me-2"></i>
                    <strong>Upload Complete!</strong><br>
                    Successfully processed ${recordCount} records from ${sheets.length} campaigns
                `;
                errorList.innerHTML = '';
            } else {
                resultAlert.className = 'alert alert-warning';
                resultAlert.innerHTML = `
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>Upload Completed with Warnings</strong><br>
                    Processed ${recordCount} records from ${sheets.length} campaigns<br>
                    ${errors.length} sheets had issues
                `;
                
                let errorHtml = '<h6 class="mt-3 text-danger">Issues Found:</h6><ul class="list-group">';
                errors.forEach(error => {
                    errorHtml += `
                        <li class="list-group-item list-group-item-warning">
                            <i class="fas fa-exclamation-circle me-2"></i>${error}
                        </li>
                    `;
                });
                errorHtml += '</ul>';
                errorList.innerHTML = errorHtml;
            }
            
            validationDiv.scrollIntoView({ behavior: 'smooth' });
        }

        // History functions (Admin only)
        function refreshHistory() {
            if (!currentUser || currentUser.role !== 'admin') return;
            
            const historyList = document.getElementById('historyList');
            const noHistoryMessage = document.getElementById('noHistoryMessage');
            
            if (uploadHistory.length === 0) {
                historyList.innerHTML = '';
                noHistoryMessage.style.display = 'block';
                return;
            }
            
            noHistoryMessage.style.display = 'none';
            
            let html = '';
            uploadHistory.forEach((record, index) => {
                const statusClass = record.status === 'Success' ? 'success' : 'warning';
                const expanded = index === 0 ? 'expanded' : '';
                
                html += `
                    <div class="history-record ${expanded}" id="history-${record.id}">
                        <div class="history-header" onclick="toggleHistoryDetails(${record.id})">
                            <div>
                                <h6 class="mb-1">
                                    <i class="fas fa-file-excel me-2"></i>${record.filename}
                                    <span class="badge bg-${statusClass} ms-2">${record.status}</span>
                                </h6>
                                <small class="text-muted">
                                    <i class="fas fa-calendar me-1"></i>${record.date}
                                    ${record.uploadedBy ? ` | Uploaded by: ${record.uploadedBy}` : ''}
                                </small>
                            </div>
                            <div>
                                <span class="badge bg-primary me-2">${record.campaigns} campaigns</span>
                                <span class="badge bg-info">${record.records} records</span>
                                <i class="fas fa-chevron-down ms-3" id="chevron-${record.id}"></i>
                            </div>
                        </div>
                        
                        <div class="history-details" id="details-${record.id}">
                            <div class="history-stats">
                                <div class="history-stat-item">
                                    <div class="history-stat-label">Total Calls</div>
                                    <div class="history-stat-value">${record.summary?.totalCalls?.toLocaleString() || '0'}</div>
                                </div>
                                <div class="history-stat-item">
                                    <div class="history-stat-label">Total Sales</div>
                                    <div class="history-stat-value">${record.summary?.totalSales?.toLocaleString() || '0'}</div>
                                </div>
                                <div class="history-stat-item">
                                    <div class="history-stat-label">Avg Ratio</div>
                                    <div class="history-stat-value">${record.summary?.avgRatio || '0'}%</div>
                                </div>
                                <div class="history-stat-item">
                                    <div class="history-stat-label">Agents</div>
                                    <div class="history-stat-value">${record.summary?.uniqueAgents || '0'}</div>
                                </div>
                                <div class="history-stat-item">
                                    <div class="history-stat-label">Team Leaders</div>
                                    <div class="history-stat-value">${record.summary?.uniqueTeamLeaders || '0'}</div>
                                </div>
                            </div>
                            
                            <div class="mt-3">
                                <strong>Campaigns:</strong>
                                ${record.campaignList ? record.campaignList.map(c => 
                                    `<span class="campaign-badge">${c}</span>`
                                ).join(' ') : 'N/A'}
                            </div>
                            
                            ${record.errors && record.errors.length > 0 ? `
                                <div class="mt-3">
                                    <strong class="text-warning">Warnings/Errors:</strong>
                                    <ul class="mt-2">
                                        ${record.errors.map(e => `<li class="text-danger">${e}</li>`).join('')}
                                    </ul>
                                </div>
                            ` : ''}
                            
                            <div class="mt-3 text-end">
                                <button class="view-data-btn" onclick="viewHistoryData(${record.id})">
                                    <i class="fas fa-eye me-1"></i>View Data
                                </button>
                                <button class="restore-btn" onclick="restoreHistoryData(${record.id})">
                                    <i class="fas fa-undo me-1"></i>Restore
                                </button>
                                <button class="delete-btn" onclick="deleteHistoryRecord(${record.id})">
                                    <i class="fas fa-trash me-1"></i>Delete
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            historyList.innerHTML = html;
            
            // Auto-expand the first record
            if (uploadHistory.length > 0) {
                document.getElementById(`details-${uploadHistory[0].id}`)?.classList.add('show');
            }
        }

        function toggleHistoryDetails(id) {
            if (!currentUser || currentUser.role !== 'admin') return;
            
            const details = document.getElementById(`details-${id}`);
            const chevron = document.getElementById(`chevron-${id}`);
            
            if (details) {
                details.classList.toggle('show');
                if (chevron) {
                    chevron.style.transform = details.classList.contains('show') ? 'rotate(180deg)' : 'rotate(0)';
                }
            }
        }

        function viewHistoryData(id) {
            const record = uploadHistory.find(r => r.id === id);
            if (!record || !record.data) {
                showToast('No data available for this upload', 'warning');
                return;
            }
            
            currentPreviewId = id;
            
            // Update modal title and info
            document.getElementById('previewFilename').textContent = record.filename;
            document.getElementById('previewDate').textContent = record.date;
            document.getElementById('previewRecords').textContent = record.records;
            document.getElementById('previewCampaigns').textContent = record.campaigns;
            
            // Create data table
            const previewContainer = document.getElementById('dataPreviewContainer');
            
            if (record.data && record.data.length > 0) {
                let tableHtml = '<table class="table table-sm table-bordered"><thead><tr>';
                
                // Headers
                const headers = ['Campaign', 'USER NAME', 'ID', 'TEAM LEADER', 'CALLS', 'SALE', 'Closing Ratio'];
                headers.forEach(h => {
                    tableHtml += `<th>${h}</th>`;
                });
                tableHtml += '</tr></thead><tbody>';
                
                // Data rows (show first 100 records)
                const previewData = record.data.slice(0, 100);
                previewData.forEach(row => {
                    tableHtml += '<tr>';
                    tableHtml += `<td>${row.CAMPAIGN || ''}</td>`;
                    tableHtml += `<td>${row['USER NAME'] || ''}</td>`;
                    tableHtml += `<td>${row.ID || ''}</td>`;
                    tableHtml += `<td>${row['TEAM LEADER'] || ''}</td>`;
                    tableHtml += `<td>${row.CALLS || 0}</td>`;
                    tableHtml += `<td>${row.SALE || 0}</td>`;
                    tableHtml += `<td>${row.closingRatio || '0'}%</td>`;
                    tableHtml += '</tr>';
                });
                
                if (record.data.length > 100) {
                    tableHtml += `<tr><td colspan="7" class="text-center text-muted">Showing first 100 of ${record.data.length} records</td></tr>`;
                }
                
                tableHtml += '</tbody></table>';
                previewContainer.innerHTML = tableHtml;
            } else {
                previewContainer.innerHTML = '<p class="text-muted text-center">No data available</p>';
            }
            
            modalInstance.show();
        }

        function restoreHistoryData(id) {
            if (!currentUser || currentUser.role !== 'admin') {
                showToast('Only admins can restore data', 'danger');
                return;
            }
            
            if (!id && currentPreviewId) {
                id = currentPreviewId;
            }
            
            const record = uploadHistory.find(r => r.id === id);
            if (!record || !record.data) {
                showToast('No data available to restore', 'warning');
                return;
            }
            
            if (confirm('Restore this version? Current data will be replaced.')) {
                showLoading('Restoring data...');
                
                // Clear current data
                performanceData = {
                    campaigns: {},
                    teamLeaders: {},
                    agents: {},
                    records: []
                };
                
                // Restore from history
                record.data.forEach(recordItem => {
                    performanceData.records.push({
                        ...recordItem,
                        id: Date.now() + Math.random(),
                        uploadDate: new Date().toISOString()
                    });
                    
                    // Update campaign data
                    const campaign = recordItem['CAMPAIGN'];
                    if (!performanceData.campaigns[campaign]) {
                        performanceData.campaigns[campaign] = {
                            totalCalls: 0,
                            totalSales: 0,
                            agents: new Set(),
                            records: []
                        };
                    }
                    performanceData.campaigns[campaign].totalCalls += recordItem['CALLS'];
                    performanceData.campaigns[campaign].totalSales += recordItem['SALE'];
                    performanceData.campaigns[campaign].agents.add(recordItem['USER NAME']);
                    performanceData.campaigns[campaign].records.push(recordItem);
                    
                    // Update team leader data
                    const leader = recordItem['TEAM LEADER'];
                    if (!performanceData.teamLeaders[leader]) {
                        performanceData.teamLeaders[leader] = {
                            totalCalls: 0,
                            totalSales: 0,
                            agents: new Set(),
                            campaigns: new Set()
                        };
                    }
                    performanceData.teamLeaders[leader].totalCalls += recordItem['CALLS'];
                    performanceData.teamLeaders[leader].totalSales += recordItem['SALE'];
                    performanceData.teamLeaders[leader].agents.add(recordItem['USER NAME']);
                    performanceData.teamLeaders[leader].campaigns.add(campaign);
                    
                    // Update agent data
                    const agentKey = `${recordItem['USER NAME']} (${recordItem['ID']})`;
                    if (!performanceData.agents[agentKey]) {
                        performanceData.agents[agentKey] = {
                            name: recordItem['USER NAME'],
                            userId: recordItem['ID'],
                            teamLeader: recordItem['TEAM LEADER'],
                            campaigns: new Set(),
                            totalCalls: 0,
                            totalSales: 0
                        };
                    }
                    performanceData.agents[agentKey].totalCalls += recordItem['CALLS'];
                    performanceData.agents[agentKey].totalSales += recordItem['SALE'];
                    performanceData.agents[agentKey].campaigns.add(campaign);
                });
                
                saveToStorage();
                hideLoading();
                
                // Close modal if open
                modalInstance.hide();
                
                // Refresh dashboard
                refreshData();
                showToast('Data restored successfully', 'success');
            }
        }

        function deleteHistoryRecord(id) {
            if (!currentUser || currentUser.role !== 'admin') {
                showToast('Only admins can delete history', 'danger');
                return;
            }
            
            if (confirm('Delete this history record? This action cannot be undone.')) {
                uploadHistory = uploadHistory.filter(r => r.id !== id);
                saveToStorage();
                refreshHistory();
                showToast('History record deleted', 'info');
            }
        }

        function exportHistoryData() {
            if (!currentUser || currentUser.role !== 'admin') {
                showToast('Only admins can export history', 'danger');
                return;
            }
            
            if (!currentPreviewId) return;
            
            const record = uploadHistory.find(r => r.id === currentPreviewId);
            if (!record || !record.data) return;
            
            const ws = XLSX.utils.json_to_sheet(record.data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Performance Data');
            
            // Add summary sheet
            const summary = [{
                'Filename': record.filename,
                'Upload Date': record.date,
                'Total Records': record.records,
                'Campaigns': record.campaigns,
                'Campaign List': record.campaignList?.join(', ') || '',
                'Total Calls': record.summary?.totalCalls || 0,
                'Total Sales': record.summary?.totalSales || 0,
                'Average Ratio': record.summary?.avgRatio + '%' || '0%',
                'Unique Agents': record.summary?.uniqueAgents || 0,
                'Team Leaders': record.summary?.uniqueTeamLeaders || 0
            }];
            
            const ws2 = XLSX.utils.json_to_sheet(summary);
            XLSX.utils.book_append_sheet(wb, ws2, 'Summary');
            
            const date = new Date().toISOString().slice(0,10);
            XLSX.writeFile(wb, `History_${record.filename.replace('.xlsx', '')}_${date}.xlsx`);
            
            showToast('History data exported successfully', 'success');
        }

        // Dashboard functions (accessible to all users)
        function refreshData() {
            showLoading('Updating dashboard...');
            setTimeout(() => {
                updateDashboard();
                hideLoading();
                showToast('Dashboard updated', 'success');
            }, 500);
        }

        function applyFilters() {
            currentFilters = {
                campaign: document.getElementById('campaignFilter').value,
                team_leader: document.getElementById('teamLeaderFilter').value,
                agent: document.getElementById('agentFilter').value
            };
            updateDashboard();
        }

        function updateDashboard() {
            updateSummaryStats();
            updateStatCards();
            updateCampaignQuickStats();
            updateRankings();
            updateCampaignsTable();
            updateTeamLeadersTable();
            updateAgentsTable();
            updateFilters();
        }

        function updateSummaryStats() {
            const filteredRecords = filterRecords(performanceData.records);
            
            const totalCalls = filteredRecords.reduce((sum, r) => sum + r['CALLS'], 0);
            const totalSales = filteredRecords.reduce((sum, r) => sum + r['SALE'], 0);
            const uniqueCampaigns = new Set(filteredRecords.map(r => r['CAMPAIGN'])).size;
            const uniqueAgents = new Set(filteredRecords.map(r => r['USER NAME'])).size;
            
            document.getElementById('totalCampaigns').textContent = uniqueCampaigns;
            document.getElementById('totalAgents').textContent = uniqueAgents;
            document.getElementById('totalCalls').textContent = totalCalls.toLocaleString();
            document.getElementById('totalSales').textContent = totalSales.toLocaleString();
        }

        function filterRecords(records) {
            return records.filter(record => {
                if (currentFilters.campaign !== 'all' && record['CAMPAIGN'] !== currentFilters.campaign) return false;
                if (currentFilters.team_leader !== 'all' && record['TEAM LEADER'] !== currentFilters.team_leader) return false;
                if (currentFilters.agent !== 'all' && record['USER NAME'] !== currentFilters.agent) return false;
                return true;
            });
        }

        function updateFilters() {
            const campaigns = new Set(performanceData.records.map(r => r['CAMPAIGN']));
            const leaders = new Set(performanceData.records.map(r => r['TEAM LEADER']));
            const agents = new Set(performanceData.records.map(r => r['USER NAME']));
            
            updateSelect('campaignFilter', campaigns, currentFilters.campaign);
            updateSelect('teamLeaderFilter', leaders, currentFilters.team_leader);
            updateSelect('agentFilter', agents, currentFilters.agent);
        }

        function updateSelect(elementId, options, selectedValue) {
            const select = document.getElementById(elementId);
            select.innerHTML = '<option value="all">All</option>';
            
            Array.from(options).sort().forEach(option => {
                if (option) {
                    const optionEl = document.createElement('option');
                    optionEl.value = option;
                    optionEl.textContent = option;
                    if (option === selectedValue) optionEl.selected = true;
                    select.appendChild(optionEl);
                }
            });
        }

        function updateStatCards() {
            const filteredRecords = filterRecords(performanceData.records);
            
            const totalCalls = filteredRecords.reduce((sum, r) => sum + r['CALLS'], 0);
            const totalSales = filteredRecords.reduce((sum, r) => sum + r['SALE'], 0);
            const avgRatio = totalCalls > 0 ? ((totalSales / totalCalls) * 100).toFixed(2) : 0;
            
            // Calculate team leader stats
            const leaders = new Set(filteredRecords.map(r => r['TEAM LEADER'])).size;
            
            // Calculate performance distribution
            const agents = Object.values(performanceData.agents);
            const excellent = agents.filter(a => (a.totalSales / a.totalCalls * 100) >= 10).length;
            const good = agents.filter(a => {
                const ratio = a.totalSales / a.totalCalls * 100;
                return ratio >= 5 && ratio < 10;
            }).length;
            const improvement = agents.filter(a => {
                const ratio = a.totalSales / a.totalCalls * 100;
                return ratio >= 2 && ratio < 5;
            }).length;
            const critical = agents.filter(a => {
                const ratio = a.totalSales / a.totalCalls * 100;
                return ratio < 2;
            }).length;
            
            const html = `
                <div class="col-md-3">
                    <div class="stat-card d-flex align-items-center">
                        <div class="stat-icon blue">
                            <i class="fas fa-bullhorn"></i>
                        </div>
                        <div>
                            <h6 class="text-muted mb-1">Active Campaigns</h6>
                            <h3 class="mb-0">${Object.keys(performanceData.campaigns).length}</h3>
                            <small class="text-muted">of ${CAMPAIGNS.length} total</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card d-flex align-items-center">
                        <div class="stat-icon green">
                            <i class="fas fa-users"></i>
                        </div>
                        <div>
                            <h6 class="text-muted mb-1">Team Leaders</h6>
                            <h3 class="mb-0">${leaders}</h3>
                            <small class="text-muted">managing ${Object.keys(performanceData.agents).length} agents</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card d-flex align-items-center">
                        <div class="stat-icon orange">
                            <i class="fas fa-percentage"></i>
                        </div>
                        <div>
                            <h6 class="text-muted mb-1">Avg Closing Ratio</h6>
                            <h3 class="mb-0">${avgRatio}%</h3>
                            <small class="text-muted">${totalSales} sales / ${totalCalls} calls</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card d-flex align-items-center">
                        <div class="stat-icon purple">
                            <i class="fas fa-star"></i>
                        </div>
                        <div>
                            <h6 class="text-muted mb-1">Top Performers</h6>
                            <h3 class="mb-0">${excellent}</h3>
                            <small class="text-muted">agents with â‰¥10% ratio</small>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('statCards').innerHTML = html;
        }

        function updateCampaignQuickStats() {
            let html = '';
            
            CAMPAIGNS.forEach(campaign => {
                const campaignData = performanceData.campaigns[campaign];
                if (campaignData) {
                    const ratio = campaignData.totalCalls > 0 ? 
                        ((campaignData.totalSales / campaignData.totalCalls) * 100).toFixed(2) : 0;
                    
                    let badgeClass = 'bg-secondary';
                    if (ratio >= 8) badgeClass = 'badge-high';
                    else if (ratio >= 5) badgeClass = 'badge-medium';
                    else if (ratio >= 2) badgeClass = 'badge-low';
                    
                    html += `
                        <div class="campaign-badge ${badgeClass} me-2 mb-2" style="cursor: pointer;" onclick="filterByCampaign('${campaign}')">
                            ${campaign}: ${ratio}% (${campaignData.agents.size} agents)
                        </div>
                    `;
                } else {
                    html += `
                        <div class="campaign-badge bg-secondary me-2 mb-2">
                            ${campaign}: No data
                        </div>
                    `;
                }
            });
            
            document.getElementById('campaignQuickStats').innerHTML = html || '<p class="text-muted">No campaign data available</p>';
        }

        function filterByCampaign(campaign) {
            document.getElementById('campaignFilter').value = campaign;
            currentFilters.campaign = campaign;
            updateDashboard();
            showSection('dashboard');
            showToast(`Filtered by campaign: ${campaign}`, 'info');
        }

        function updateRankings() {
            const agents = Object.values(performanceData.agents)
                .map(agent => ({
                    ...agent,
                    closingRatio: agent.totalCalls > 0 ? 
                        ((agent.totalSales / agent.totalCalls) * 100).toFixed(2) : 0,
                    campaignsCount: agent.campaigns.size
                }))
                .sort((a, b) => b.closingRatio - a.closingRatio);
            
            const top10 = agents.slice(0, 10);
            const bottom10 = agents.slice(-10).reverse();
            
            // Update performance distribution
            const excellent = agents.filter(a => a.closingRatio >= 10).length;
            const good = agents.filter(a => a.closingRatio >= 5 && a.closingRatio < 10).length;
            const improvement = agents.filter(a => a.closingRatio >= 2 && a.closingRatio < 5).length;
            const critical = agents.filter(a => a.closingRatio < 2).length;
            
            document.getElementById('excellentCount').textContent = excellent;
            document.getElementById('goodCount').textContent = good;
            document.getElementById('improvementCount').textContent = improvement;
            document.getElementById('criticalCount').textContent = critical;
            
            // Top performers
            let topHtml = '';
            top10.forEach((agent, index) => {
                topHtml += `
                    <div class="ranking-card high">
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="d-flex align-items-center">
                                <span class="ranking-position">#${index + 1}</span>
                                <div>
                                    <h6 class="mb-0">${agent.name}</h6>
                                    <small class="text-muted">
                                        <i class="fas fa-user-tie me-1"></i>${agent.teamLeader} | 
                                        <i class="fas fa-bullhorn me-1"></i>${agent.campaignsCount} campaigns
                                    </small>
                                </div>
                            </div>
                            <div class="text-end">
                                <span class="badge-high">${agent.closingRatio}%</span>
                                <br>
                                <small class="text-muted">${agent.totalSales}/${agent.totalCalls}</small>
                            </div>
                        </div>
                    </div>
                `;
            });
            document.getElementById('topPerformers').innerHTML = topHtml || '<p class="text-muted">No data available</p>';
            
            // Bottom performers
            let bottomHtml = '';
            bottom10.forEach((agent, index) => {
                bottomHtml += `
                    <div class="ranking-card low">
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="d-flex align-items-center">
                                <span class="ranking-position">#${agents.length - index}</span>
                                <div>
                                    <h6 class="mb-0">${agent.name}</h6>
                                    <small class="text-muted">
                                        <i class="fas fa-user-tie me-1"></i>${agent.teamLeader} | 
                                        <i class="fas fa-bullhorn me-1"></i>${agent.campaignsCount} campaigns
                                    </small>
                                </div>
                            </div>
                            <div class="text-end">
                                <span class="badge-low">${agent.closingRatio}%</span>
                                <br>
                                <small class="text-muted">${agent.totalSales}/${agent.totalCalls}</small>
                            </div>
                        </div>
                    </div>
                `;
            });
            document.getElementById('bottomPerformers').innerHTML = bottomHtml || '<p class="text-muted">No data available</p>';
        }

        function updateCampaignsTable() {
            let html = '';
            
            CAMPAIGNS.forEach(campaign => {
                const data = performanceData.campaigns[campaign];
                if (data) {
                    const ratio = data.totalCalls > 0 ? ((data.totalSales / data.totalCalls) * 100).toFixed(2) : 0;
                    
                    let badgeClass = 'bg-secondary';
                    if (ratio >= 8) badgeClass = 'badge-high';
                    else if (ratio >= 5) badgeClass = 'badge-medium';
                    else if (ratio >= 2) badgeClass = 'badge-low';
                    
                    // Find top agent in this campaign
                    let topAgent = 'N/A';
                    let topRatio = 0;
                    if (data.records && data.records.length > 0) {
                        const campaignAgents = data.records.map(r => ({
                            name: r['USER NAME'],
                            ratio: r['SALE'] / r['CALLS'] * 100
                        })).sort((a, b) => b.ratio - a.ratio);
                        
                        if (campaignAgents.length > 0) {
                            topAgent = campaignAgents[0].name;
                            topRatio = campaignAgents[0].ratio.toFixed(2);
                        }
                    }
                    
                    html += `
                        <tr onclick="filterByCampaign('${campaign}')" style="cursor: pointer;">
                            <td><strong>${campaign}</strong></td>
                            <td>${data.agents.size}</td>
                            <td>${data.totalCalls.toLocaleString()}</td>
                            <td>${data.totalSales.toLocaleString()}</td>
                            <td>
                                <span class="badge-performance ${badgeClass}">
                                    ${ratio}%
                                </span>
                            </td>
                            <td>${topAgent}</td>
                            <td>${topRatio}%</td>
                        </tr>
                    `;
                } else {
                    html += `
                        <tr>
                            <td><strong>${campaign}</strong></td>
                            <td colspan="6" class="text-muted">No data available</td>
                        </tr>
                    `;
                }
            });
            
            document.getElementById('campaignsTable').innerHTML = html;
            document.getElementById('allCampaignsTable').innerHTML = html;
        }

        function updateTeamLeadersTable() {
            let html = '';
            
            for (const [name, data] of Object.entries(performanceData.teamLeaders)) {
                const ratio = data.totalCalls > 0 ? ((data.totalSales / data.totalCalls) * 100).toFixed(2) : 0;
                
                // Calculate team average (average of agent ratios)
                const agentRatios = [];
                data.agents.forEach(agentName => {
                    const agent = Object.values(performanceData.agents).find(a => a.name === agentName);
                    if (agent && agent.totalCalls > 0) {
                        agentRatios.push((agent.totalSales / agent.totalCalls) * 100);
                    }
                });
                const teamAvg = agentRatios.length > 0 ? 
                    (agentRatios.reduce((a, b) => a + b, 0) / agentRatios.length).toFixed(2) : 0;
                
                let badgeClass = 'bg-secondary';
                if (ratio >= 8) badgeClass = 'badge-high';
                else if (ratio >= 5) badgeClass = 'badge-medium';
                else if (ratio >= 2) badgeClass = 'badge-low';
                
                html += `
                    <tr>
                        <td><strong>${name}</strong></td>
                        <td>${data.agents.size}</td>
                        <td>${data.campaigns.size}</td>
                        <td>${data.totalCalls.toLocaleString()}</td>
                        <td>${data.totalSales.toLocaleString()}</td>
                        <td>
                            <span class="badge-performance ${badgeClass}">
                                ${ratio}%
                            </span>
                        </td>
                        <td>${teamAvg}%</td>
                    </tr>
                `;
            }
            
            document.getElementById('teamLeadersTable').innerHTML = html || '<tr><td colspan="7" class="text-center">No data available</td></tr>';
            document.getElementById('allTeamLeadersTable').innerHTML = html || '<tr><td colspan="7" class="text-center">No data available</td></tr>';
        }

        function updateAgentsTable() {
            let html = '';
            const agents = Object.values(performanceData.agents)
                .map(agent => ({
                    ...agent,
                    closingRatio: agent.totalCalls > 0 ? 
                        ((agent.totalSales / agent.totalCalls) * 100).toFixed(2) : 0,
                    campaignsList: Array.from(agent.campaigns).join(', ')
                }))
                .sort((a, b) => b.closingRatio - a.closingRatio);
            
            agents.forEach((agent, index) => {
                let badgeClass = 'bg-secondary';
                if (agent.closingRatio >= 10) badgeClass = 'badge-high';
                else if (agent.closingRatio >= 5) badgeClass = 'badge-medium';
                else if (agent.closingRatio >= 2) badgeClass = 'badge-low';
                
                html += `
                    <tr>
                        <td><strong>${agent.name}</strong></td>
                        <td>${agent.userId}</td>
                        <td>${agent.teamLeader}</td>
                        <td>${agent.campaigns.size}</td>
                        <td>${agent.totalCalls.toLocaleString()}</td>
                        <td>${agent.totalSales.toLocaleString()}</td>
                        <td>
                            <span class="badge-performance ${badgeClass}">
                                ${agent.closingRatio}%
                            </span>
                        </td>
                        <td>#${index + 1}</td>
                    </tr>
                `;
            });
            
            document.getElementById('agentsTable').innerHTML = html || '<tr><td colspan="8" class="text-center">No data available</td></tr>';
            document.getElementById('agentsFullTable').querySelector('tbody').innerHTML = html || '<tr><td colspan="8" class="text-center">No data available</td></tr>';
        }

        function loadCampaignsData() {
            updateCampaignsTable();
        }

        function loadAgentsData() {
            updateAgentsTable();
        }

        function loadTeamLeadersData() {
            updateTeamLeadersTable();
        }

        function loadRankingsData() {
            updateRankings();
        }

        function exportData() {
            const data = performanceData.records.map(record => ({
                'Campaign': record['CAMPAIGN'],
                'Agent Name': record['USER NAME'],
                'User ID': record['ID'],
                'Team Leader': record['TEAM LEADER'],
                'Total Calls': record['CALLS'],
                'Total Sales': record['SALE'],
                'Closing Ratio': record.closingRatio + '%'
            }));
            
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Performance Data');
            
            // Add summary sheet
            const summary = CAMPAIGNS.map(campaign => {
                const data = performanceData.campaigns[campaign];
                if (data) {
                    const ratio = data.totalCalls > 0 ? ((data.totalSales / data.totalCalls) * 100).toFixed(2) : 0;
                    return {
                        'Campaign': campaign,
                        'Agents': data.agents.size,
                        'Total Calls': data.totalCalls,
                        'Total Sales': data.totalSales,
                        'Closing Ratio': ratio + '%'
                    };
                }
                return null;
            }).filter(s => s !== null);
            
            const ws2 = XLSX.utils.json_to_sheet(summary);
            XLSX.utils.book_append_sheet(wb, ws2, 'Campaign Summary');
            
            const date = new Date().toISOString().slice(0,10);
            XLSX.writeFile(wb, `MTD_Closing_Ratio_${date}.xlsx`);
            
            showToast('Data exported successfully', 'success');
        }
    </script>
</body>
</html>